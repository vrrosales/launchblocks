---
phase: 02-cli-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/errors.ts
  - src/interview/questions/ai-tool.ts
  - src/interview/questions/signup.ts
  - src/interview/questions/roles.ts
  - src/interview/questions/permissions.ts
  - src/interview/questions/admin-access.ts
  - src/interview/questions/llm-access.ts
  - src/interview/questions/providers.ts
  - src/interview/questions/app-info.ts
  - src/interview/questions/billing.ts
  - src/setup/guide.ts
  - src/setup/runner.ts
  - src/commands/init.ts
  - src/commands/add.ts
autonomous: true
requirements: [CLI-01]

must_haves:
  truths:
    - "Cancelling the interview at any question throws CancellationError instead of calling process.exit(0)"
    - "Cancelling during MCP setup skips setup instead of aborting the entire init"
    - "The top-level command handlers catch CancellationError and exit cleanly with code 0"
    - "No process.exit(0) calls remain in question files or setup/guide.ts"
    - "The project builds cleanly with npm run build after all changes"
  artifacts:
    - path: "src/utils/errors.ts"
      provides: "CancellationError class for graceful shutdown"
      exports: ["CancellationError"]
    - path: "src/commands/init.ts"
      provides: "Top-level CancellationError catch in initCommand"
      contains: "instanceof CancellationError"
    - path: "src/commands/add.ts"
      provides: "Top-level CancellationError catch in addRoleCommand and addProviderCommand"
      contains: "instanceof CancellationError"
    - path: "src/setup/runner.ts"
      provides: "CancellationError catch in runSetup that skips MCP setup instead of aborting"
      contains: "instanceof CancellationError"
  key_links:
    - from: "src/interview/questions/*.ts"
      to: "src/utils/errors.ts"
      via: "import and throw CancellationError"
      pattern: "throw new CancellationError"
    - from: "src/setup/guide.ts"
      to: "src/utils/errors.ts"
      via: "import and throw CancellationError"
      pattern: "throw new CancellationError"
    - from: "src/commands/init.ts"
      to: "src/utils/errors.ts"
      via: "catch CancellationError in initCommand"
      pattern: "error instanceof CancellationError"
    - from: "src/setup/runner.ts"
      to: "src/utils/errors.ts"
      via: "catch CancellationError in runSetup to skip MCP"
      pattern: "error instanceof CancellationError"
---

<objective>
Replace all `process.exit(0)` calls in interview question files and setup guide with a CancellationError throw pattern, and catch it at the top-level command handlers for graceful shutdown.

Purpose: Make question functions testable, enable future cleanup hooks, and ensure cancellation propagates cleanly through the call stack instead of hard-exiting the process from deep within helper functions.

Output: `src/utils/errors.ts` with CancellationError class; all 9 question files and `setup/guide.ts` throw instead of exit; command handlers catch CancellationError; `runSetup` catches CancellationError to skip MCP setup gracefully.
</objective>

<execution_context>
@/Users/vrrosales/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vrrosales/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-hardening/02-RESEARCH.md

@src/utils/logger.ts
@src/interview/questions/ai-tool.ts
@src/interview/questions/signup.ts
@src/interview/questions/roles.ts
@src/interview/questions/permissions.ts
@src/interview/questions/admin-access.ts
@src/interview/questions/llm-access.ts
@src/interview/questions/providers.ts
@src/interview/questions/app-info.ts
@src/interview/questions/billing.ts
@src/setup/guide.ts
@src/setup/runner.ts
@src/commands/init.ts
@src/commands/add.ts

<interfaces>
<!-- From src/generator/config-reader.ts — ConfigValidationError pattern to follow -->
export class ConfigValidationError extends Error {
  public readonly errors: string[];
  constructor(errors: string[]) {
    const message = errors.length === 1
      ? `Config validation error: ${errors[0]}`
      : `Config validation errors:\n${errors.map((e, i) => `  ${i + 1}. ${e}`).join("\n")}`;
    super(message);
    this.name = "ConfigValidationError";
    this.errors = errors;
  }
}
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CancellationError and replace all process.exit(0) in question files and setup guide</name>
  <files>
    src/utils/errors.ts
    src/interview/questions/ai-tool.ts
    src/interview/questions/signup.ts
    src/interview/questions/roles.ts
    src/interview/questions/permissions.ts
    src/interview/questions/admin-access.ts
    src/interview/questions/llm-access.ts
    src/interview/questions/providers.ts
    src/interview/questions/app-info.ts
    src/interview/questions/billing.ts
    src/setup/guide.ts
  </files>
  <action>
1. Create `src/utils/errors.ts` with a `CancellationError` class:
   ```typescript
   export class CancellationError extends Error {
     constructor(message = "Operation cancelled.") {
       super(message);
       this.name = "CancellationError";
     }
   }
   ```
   Follow the ConfigValidationError pattern from config-reader.ts (extends Error, sets this.name).

2. In each of the 9 interview question files, replace the `process.exit(0)` pattern:
   - Add `import { CancellationError } from "../../utils/errors.js";` to each file
   - Replace every `process.exit(0);` that follows a `cancel("Operation cancelled.");` with `throw new CancellationError();`
   - Keep the `cancel()` call (it handles the display output from @clack/prompts)
   - Do NOT add any other changes to these files

   Complete list of sites (from research audit):
   - `ai-tool.ts:19` — 1 site
   - `signup.ts:18` — 1 site
   - `roles.ts:29,51,63,73` — 4 sites
   - `permissions.ts:29` — 1 site
   - `admin-access.ts:41,57` — 2 sites
   - `llm-access.ts:15,33` — 2 sites
   - `providers.ts:21` — 1 site
   - `app-info.ts:17` — 1 site
   - `billing.ts:24,51` — 2 sites

3. In `src/setup/guide.ts`, apply the same pattern to all 3 `process.exit(0)` sites:
   - `guideService` hasAccount cancel (line ~45)
   - `guideService` created cancel (line ~60)
   - `guideService` scope cancel (line ~101)
   - Add `import { CancellationError } from "../utils/errors.js";`
   - Replace `process.exit(0);` with `throw new CancellationError();`

IMPORTANT: Do NOT call `cancel()` at the top level after the throw — the question function already calls `cancel()` for display. The top-level catch should NOT call `cancel()` again (would double-print the message).
  </action>
  <verify>
    <automated>cd /Users/vrrosales/Desktop/Coding/VibeKit-cli && npx grep -rn "process.exit(0)" src/interview/questions/ src/setup/guide.ts | wc -l | xargs test 0 -eq && echo "PASS: No process.exit(0) in question files or guide.ts" || echo "FAIL: process.exit(0) still found"</automated>
  </verify>
  <done>
    - `src/utils/errors.ts` exists and exports CancellationError
    - All 18 `process.exit(0)` sites in question files are replaced with `throw new CancellationError()`
    - All 3 `process.exit(0)` sites in `setup/guide.ts` are replaced with `throw new CancellationError()`
    - The `cancel()` call from @clack/prompts is preserved before each throw
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CancellationError catch into command handlers and runSetup</name>
  <files>
    src/commands/init.ts
    src/commands/add.ts
    src/setup/runner.ts
  </files>
  <action>
1. In `src/commands/init.ts`, update the `initCommand` catch block:
   - Add `import { CancellationError } from "../utils/errors.js";`
   - In the existing catch block (line ~277), add a CancellationError check BEFORE the generic error handler:
     ```typescript
     } catch (error) {
       if (error instanceof CancellationError) {
         process.exit(0);  // cancel() already printed the message
       }
       logger.error(
         error instanceof Error ? error.message : "An unexpected error occurred."
       );
       process.exit(1);
     }
     ```
   - Also replace the `process.exit(0)` at line ~214 (the `isCancel(action)` block for the regenerate prompt) with `throw new CancellationError()`. This is the one remaining `process.exit(0)` in init.ts that needs to throw instead.

2. In `src/commands/add.ts`, update both command handler catch blocks:
   - Add `import { CancellationError } from "../utils/errors.js";`
   - In `addRoleCommand`'s catch block (line ~148), add CancellationError check before generic handler (same pattern as init.ts)
   - In `addProviderCommand`'s catch block (line ~208), add CancellationError check before generic handler
   - Replace the `process.exit(0)` at line ~82 (the `isCancel(selected)` block for permissions multiselect) with `throw new CancellationError()`

3. In `src/setup/runner.ts`, wrap the `guideService` call in a try/catch that catches CancellationError and treats it as "skip MCP setup":
   - Add `import { CancellationError } from "../utils/errors.js";`
   - Wrap the `for (const name of services)` loop body in try/catch:
     ```typescript
     for (const name of services) {
       try {
         const { installed, scope } = await guideService(name, aiTool);
         if (installed && scope) {
           result[name] = { name, installed: true, location: scope };
           result.installed.push(name);
         } else {
           result.skipped.push(name);
         }
       } catch (error) {
         if (error instanceof CancellationError) {
           result.skipped.push(name);
           continue;
         }
         throw error;
       }
     }
     ```
   This ensures cancelling during MCP setup skips that service but does NOT propagate to initCommand's catch block — the files have already been generated by this point.

4. Verify the build succeeds: `npm run build`
  </action>
  <verify>
    <automated>cd /Users/vrrosales/Desktop/Coding/VibeKit-cli && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    - `initCommand` catches CancellationError and calls `process.exit(0)` without logging
    - `addRoleCommand` and `addProviderCommand` catch CancellationError and exit cleanly
    - `runSetup` catches CancellationError from `guideService` and skips the service
    - No `process.exit(0)` remains in any question file, `setup/guide.ts`, or inside `isCancel` blocks in command files (only in the top-level catch block of each command handler)
    - `npm run build` succeeds with no errors
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "process.exit(0)" src/interview/ src/setup/guide.ts` returns zero results
2. `grep -rn "process.exit(0)" src/commands/init.ts src/commands/add.ts` returns results ONLY inside `catch` blocks (the top-level CancellationError handler)
3. `grep -rn "throw new CancellationError" src/interview/questions/` returns 18 results (one per isCancel branch)
4. `grep -rn "throw new CancellationError" src/setup/guide.ts` returns 3 results
5. `grep -rn "instanceof CancellationError" src/commands/init.ts src/commands/add.ts src/setup/runner.ts` returns 4 results (initCommand, addRoleCommand, addProviderCommand, runSetup)
6. `npm run build` succeeds
</verification>

<success_criteria>
- Zero `process.exit(0)` calls remain in interview question files or `setup/guide.ts`
- CancellationError is thrown in every `isCancel()` branch across all question files, guide.ts, and command-level isCancel checks
- Top-level command handlers (initCommand, addRoleCommand, addProviderCommand) catch CancellationError and exit with code 0
- MCP setup cancellation skips the service instead of aborting the whole init
- `npm run build` succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-hardening/02-01-SUMMARY.md`
</output>
