# Module 6: Prompt Management

> Spec for **{{app_name}}** -- generated by Launchblocks

## Purpose

Prompt Management provides an admin interface and API for creating, editing, versioning, and organizing prompt templates. These templates are consumed by the LLM Gateway (Module 5) when feature code makes template-based calls. This module ensures that prompts are centrally managed, version-tracked, and testable without deploying code changes.

## Authorization

All prompt management operations require the `manage_prompts` permission.

**Roles with this permission:**
{{#each role_permission_summary}}
{{#if has_permissions}}
- **{{this.display_name}}** (`{{this.name}}`): {{this.permissions_list}}
{{/if}}
{{/each}}

Any authenticated and approved user can **read** active templates (needed for the LLM Gateway to resolve slugs). Only users with `manage_prompts` can create, edit, deactivate, or delete templates.

## Database Schema

The `prompt_templates` table (created in migration `003_prompt_templates`) stores all templates:

| Column | Type | Description |
|---|---|---|
| `id` | uuid | Primary key |
| `slug` | text | Unique identifier for API lookups (e.g., `summarize-article`) |
| `name` | text | Human-readable name shown in admin UI |
| `description` | text | Optional description of what the template does |
| `system_prompt` | text | System message sent to the LLM |
| `user_prompt_template` | text | User message template with `\{{variable}}` placeholders |
| `model` | text | Default model for this template (e.g., `gpt-4o`) |
| `provider` | text | Default provider for this template (e.g., `{{providers_display.[0].id}}`) |
| `temperature` | numeric | Default temperature (0--2) |
| `max_tokens` | integer | Default max response tokens |
| `is_active` | boolean | Whether this template is available for use |
| `version` | integer | Auto-incrementing version number |
| `created_by` | uuid | User who created/last edited the template |
| `created_at` | timestamptz | Creation timestamp |
| `updated_at` | timestamptz | Last modification timestamp |

## Template Variables

Prompt templates use `\{{variable_name}}` syntax for dynamic content. When the LLM Gateway processes a template-based call, it replaces each `\{{variable_name}}` with the corresponding value from the request's `variables` object.

### Variable Conventions

- Variable names should use `snake_case` (e.g., `article_text`, `user_question`, `max_length`)
- Variables are plain string replacements -- no expressions, conditionals, or loops
- Missing variables are left as-is in the rendered prompt (no error thrown)
- The admin UI should parse the template text and display detected variables for documentation

### Example Template

**Name:** Summarize Article
**Slug:** `summarize-article`

**System Prompt:**
```
You are a professional editor. Summarize content clearly and concisely.
```

**User Prompt Template:**
```
Summarize the following article in \{{max_length}}:

\{{article_text}}
```

**Variables detected:** `max_length`, `article_text`

## Version History

Every edit to a prompt template creates a new version. Previous versions are immutable and preserved for auditing and rollback.

### Implementation Strategy

Rather than a separate versions table, use this approach:

1. When a template is **created**, it starts at `version = 1`
2. When a template is **edited**, the existing row is duplicated into a `prompt_template_versions` table with its current state, then the main row is updated in place with `version` incremented
3. The `prompt_templates` table always holds the **current** version
4. The `prompt_template_versions` table holds all **previous** versions

```sql
-- Add this table alongside the existing prompt_templates table
CREATE TABLE public.prompt_template_versions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL REFERENCES public.prompt_templates(id) ON DELETE CASCADE,
  version integer NOT NULL,
  slug text NOT NULL,
  name text NOT NULL,
  description text,
  system_prompt text NOT NULL,
  user_prompt_template text NOT NULL,
  model text NOT NULL,
  provider text NOT NULL,
  temperature numeric(3,2) NOT NULL,
  max_tokens integer NOT NULL,
  is_active boolean NOT NULL,
  created_by uuid REFERENCES public.user_profiles(id),
  created_at timestamptz NOT NULL,
  UNIQUE(template_id, version)
);
```

The admin UI should display the version history for each template and allow viewing (but not editing) previous versions.

## Model Configuration Per Template

Each template stores its own model configuration:

| Setting | Description | Constraint |
|---|---|---|
| `provider` | Which LLM provider to use | Must be one of: {{#each providers_display}}`{{this.id}}`{{#unless @last}}, {{/unless}}{{/each}} |
| `model` | Which model to use | Must be valid for the selected provider |
| `temperature` | Creativity/randomness | 0 -- 2, stored as numeric(3,2) |
| `max_tokens` | Maximum response length | 1 -- 128000 |

The admin UI should show a provider dropdown, then populate the model dropdown based on the selected provider. Available models per provider:

{{#each providers_display}}
**{{this.name}}:** Consult the provider's model catalog or the Celeste AI SDK documentation for available models.

{{/each}}

> **Tip:** Use the exact model identifier the provider expects (e.g., `gpt-4o`, `claude-sonnet-4-6`, `gemini-2.0-flash`). See `references/llm-pricing-table.md` for model names and pricing.

## Template Testing

The admin UI includes a testing panel that lets admins run a template with sample variables before activating it.

### Test Flow

1. Admin opens a template in the editor
2. Admin clicks "Test" to open the test panel
3. The UI shows input fields for each detected `\{{variable}}` in the template
4. Admin fills in sample values and clicks "Run Test"
5. The UI sends the test request through the LLM Gateway (`POST /api/llm/chat` with the template slug and sample variables)
6. The response is displayed in the test panel alongside token usage and cost
7. The test call is logged in `llm_audit_log` like any other call (with `request_metadata` indicating it was a test)

This ensures every test exercises the same code path as production calls.

## Template Activation and Deactivation

- **Active templates** (`is_active = true`): available for use by the LLM Gateway
- **Inactive templates** (`is_active = false`): hidden from the Gateway but preserved in the database

### Deactivation Rules

- Deactivating a template does not delete it -- it can be reactivated at any time
- The LLM Gateway returns a 404 if feature code references an inactive template's slug
- The admin list view shows both active and inactive templates with a clear visual indicator
- Toggling active/inactive counts as an edit and increments the version

## Feature Tags

Templates can be organized with feature tags for filtering in the admin UI. Tags are stored as a JSON array in the `request_metadata` column or as a separate `tags` text array column.

Recommended approach -- add a `tags` column:

```sql
ALTER TABLE public.prompt_templates ADD COLUMN tags text[] DEFAULT '{}';
CREATE INDEX idx_prompt_templates_tags ON public.prompt_templates USING GIN(tags);
```

Tags are freeform strings (e.g., `["onboarding", "email", "summarization"]`). The admin UI should provide autocomplete based on existing tags in the database.

## API Endpoints

All endpoints are under `/api/admin/prompts` and require the `manage_prompts` permission.

### `GET /api/admin/prompts`

List all prompt templates (active and inactive).

**Query parameters:**
- `search` -- filter by name or slug (case-insensitive partial match)
- `provider` -- filter by provider
- `is_active` -- filter by active status (`true` or `false`)
- `tag` -- filter by tag
- `page` -- page number (default 1)
- `per_page` -- items per page (default 20, max 100)

**Response:**
```json
{
  "templates": [
    {
      "id": "uuid",
      "slug": "summarize-article",
      "name": "Summarize Article",
      "description": "Summarizes an article to a given length",
      "provider": "{{providers_display.[0].id}}",
      "model": "gpt-4o",
      "temperature": 0.7,
      "max_tokens": 1024,
      "is_active": true,
      "version": 3,
      "tags": ["summarization", "content"],
      "created_by": "uuid",
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-01-20T14:22:00Z"
    }
  ],
  "total": 42,
  "page": 1,
  "per_page": 20
}
```

### `GET /api/admin/prompts/:id`

Get a single template with its version history.

**Response:**
```json
{
  "template": { "...current template fields..." },
  "versions": [
    { "version": 2, "created_at": "2025-01-18T09:00:00Z", "created_by": "uuid" },
    { "version": 1, "created_at": "2025-01-15T10:30:00Z", "created_by": "uuid" }
  ]
}
```

### `GET /api/admin/prompts/:id/versions/:version`

Get a specific version of a template (read-only).

### `POST /api/admin/prompts`

Create a new prompt template.

**Request body:**
```json
{
  "slug": "summarize-article",
  "name": "Summarize Article",
  "description": "Summarizes an article to a given length",
  "system_prompt": "You are a professional editor.",
  "user_prompt_template": "Summarize in \\{{max_length}}:\n\n\\{{article_text}}",
  "provider": "{{providers_display.[0].id}}",
  "model": "gpt-4o",
  "temperature": 0.7,
  "max_tokens": 1024,
  "tags": ["summarization"]
}
```

**Validation rules:**
- `slug` must be unique, lowercase, alphanumeric with hyphens only (`/^[a-z0-9-]+$/`)
- `name` is required, max 200 characters
- `system_prompt` and `user_prompt_template` are required (can be empty string)
- `provider` must be one of the configured providers
- `temperature` must be between 0 and 2
- `max_tokens` must be between 1 and 128000

### `PATCH /api/admin/prompts/:id`

Update an existing template. Before updating, the current state is saved to `prompt_template_versions` and `version` is incremented.

**Request body:** Same fields as POST (all optional -- only included fields are updated).

### `DELETE /api/admin/prompts/:id`

Soft-delete a template by setting `is_active = false`. True deletion is reserved for the `{{owner_role}}` role only.

If the `{{owner_role}}` role sends `DELETE` with query parameter `?hard=true`, the template and all its versions are permanently deleted.

## Slug-Based Lookup

The LLM Gateway uses slugs to resolve templates. The lookup endpoint is internal (not under `/api/admin/`):

```typescript
// Used internally by the LLM Gateway
async function getTemplateBySlug(slug: string): Promise<PromptTemplate | null> {
  const { data } = await supabase
    .from("prompt_templates")
    .select("*")
    .eq("slug", slug)
    .eq("is_active", true)
    .single();
  return data;
}
```

This function is imported by the gateway service, not exposed as a separate API endpoint.

## Admin UI Pages

### Template List (`/admin/prompts`)

- Table with columns: Name, Slug, Provider, Model, Status (active/inactive), Version, Updated
- Search bar for filtering by name/slug
- Filter dropdowns for provider, status, tags
- "New Template" button
- Click a row to open the editor

### Template Editor (`/admin/prompts/:id`)

- Form fields for all template properties
- Split-pane editor: system prompt on top, user prompt template on bottom
- Detected variables panel (auto-parsed from template text)
- Model configuration section (provider, model, temperature slider, max_tokens input)
- Tags input with autocomplete
- Version history sidebar showing all previous versions
- "Test" button opening the test panel
- "Save" button (creates new version)
- "Activate" / "Deactivate" toggle

### New Template (`/admin/prompts/new`)

Same form as the editor but for creating a new template.

## Implementation Tasks

Complete these tasks in order. Each task builds on the previous ones.

### Task 6.1: Create prompt_template_versions Table
Run the SQL to create the `prompt_template_versions` table (see the Version History section above). Add the `UNIQUE(template_id, version)` constraint and FK to `prompt_templates`.
**Verify:** Query `SELECT * FROM information_schema.tables WHERE table_name = 'prompt_template_versions';` and confirm the table exists.

### Task 6.2: Build CRUD API Routes
Implement the 5 API endpoints under `/api/admin/prompts`: GET (list), GET (single with versions), POST (create), PATCH (update with versioning), DELETE (soft-delete, hard-delete for `{{owner_role}}`).
**Verify:** Create a template via POST, retrieve it via GET, update it via PATCH (confirm version increments), and soft-delete via DELETE.

### Task 6.3: Add Permission Middleware
Add `manage_prompts` permission check to all `/api/admin/prompts` endpoints. Authenticated users can read active templates without this permission (for gateway use).
**Verify:** A user without `manage_prompts` receives 403 on POST/PATCH/DELETE. An authenticated user can still read active templates.

### Task 6.4: Build Template List Page
Create `/admin/prompts` with a table showing: Name, Slug, Provider, Model, Status (active/inactive badge), Version, Updated. Add search bar, filter dropdowns, and pagination.
**Verify:** The list loads with all templates, search filters by name/slug, and provider/status filters work correctly.

### Task 6.5: Build Template Editor Page
Create `/admin/prompts/:id` with a form for all template properties. Include split-pane layout: system prompt on top, user prompt template on bottom. Add model configuration section (provider dropdown, model dropdown, temperature slider, max_tokens input).
**Verify:** Open an existing template, edit the system prompt, save, and confirm the version number increments.

### Task 6.6: Implement Variable Detection
Parse template text for `\{{variable_name}}` patterns using regex. Display detected variables in a panel next to the prompt editor for documentation purposes.
**Verify:** Enter a template with `\{{article_text}}` and `\{{max_length}}` and confirm both variables are detected and displayed.

### Task 6.7: Implement Version History
When a template is edited, save the current state to `prompt_template_versions` before applying the update. Display version history in a sidebar on the editor page, allowing read-only viewing of previous versions.
**Verify:** Edit a template 3 times, then view version history showing versions 1, 2, and 3 with timestamps.

### Task 6.8: Build Test Panel
Add a "Test" button to the editor that opens a panel with input fields for each detected variable. Clicking "Run Test" sends the request through the LLM Gateway. Display the response, token usage, and cost.
**Verify:** Open a template, fill in test variables, run the test, and confirm the LLM response appears with usage stats.

### Task 6.9: Implement Tag Management
Add a tags input with autocomplete (sourced from existing tags in the database). Store tags in the `prompt_templates` table. Add tag-based filtering to the list page.
**Verify:** Add tags to a template, save, and confirm the tags appear in the list view and can be used as filters.

### Task 6.10: Wire Up Activation/Deactivation
Add an active/inactive toggle to the editor page. Toggling increments the version. Inactive templates are hidden from the LLM Gateway but remain visible in the admin list.
**Verify:** Deactivate a template and confirm the LLM Gateway returns 404 when referencing its slug. Reactivate and confirm the gateway resolves it again.

---

## Test Specifications

### Unit Tests
- [ ] Slug validation accepts lowercase alphanumeric with hyphens (`summarize-article`)
- [ ] Slug validation rejects uppercase characters, spaces, and special characters
- [ ] Variable detection regex correctly extracts `\{{variable_name}}` patterns
- [ ] Variable detection handles templates with no variables (returns empty array)
- [ ] Variable detection handles templates with duplicate variables (deduplicates)
- [ ] Temperature validation rejects values outside 0–2 range
- [ ] Max tokens validation rejects values outside 1–128000 range

### Integration Tests
- [ ] POST creates a template at version 1 with correct fields
- [ ] PATCH saves current state to `prompt_template_versions` before updating
- [ ] PATCH increments the `version` field
- [ ] DELETE (soft) sets `is_active = false` without removing the record
- [ ] DELETE (hard, `{{owner_role}}` only) permanently removes the template and all versions
- [ ] GET list returns only active templates for non-admin users
- [ ] GET list returns all templates (active and inactive) for `manage_prompts` holders
- [ ] Slug uniqueness constraint prevents duplicate slugs
- [ ] Version history endpoint returns all previous versions in descending order
- [ ] Permission middleware blocks CRUD operations for users without `manage_prompts`
- [ ] Tag filtering returns only templates with the specified tag

### E2E Tests
- [ ] Create new template → edit it twice → view version history showing 3 versions
- [ ] Create template → test it via the test panel → confirm LLM response and audit log entry
- [ ] Create template → deactivate → gateway returns 404 → reactivate → gateway resolves it
- [ ] Create template → use it via the LLM Gateway with variables → confirm interpolated prompt reaches the LLM
- [ ] `{{owner_role}}` can hard-delete a template; other admin roles cannot
