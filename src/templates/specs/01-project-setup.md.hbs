# Module 1: Project Setup & Hosting

> Application: **{{app_name}}**
> This spec covers project scaffolding, Supabase client initialization, environment configuration, and Vercel deployment.

---

## 1.1 Framework Scaffolding

Use a modern React meta-framework (Next.js App Router is recommended). The project must support:

- Server-side rendering and API routes (for secure Supabase service-role calls)
- File-based routing with layouts
- Middleware (for auth-protected routes)
- Environment variable support (`NEXT_PUBLIC_*` for client, plain for server)

### Recommended Tooling

| Tool | Purpose |
|---|---|
| Next.js (App Router) | Framework |
| TypeScript | Type safety |
| Tailwind CSS | Styling |
| Supabase JS SDK | Database and auth |
| `@supabase/ssr` | Server-side auth helpers |
| Python 3.12+ | LLM microservice runtime |
| FastAPI + Celeste AI | LLM provider abstraction |

---

## 1.2 Directory Structure

Organize the project as follows. Adapt to your framework but keep the logical separation:

```
{{app_name}}/
├── app/
│   ├── (auth)/                  # Auth route group (login, signup, etc.)
│   │   ├── login/page.tsx
│   │   ├── signup/page.tsx
│   │   ├── forgot-password/page.tsx
│   │   ├── reset-password/page.tsx
{{#if require_approval}}
│   │   ├── pending-approval/page.tsx
{{/if}}
│   │   └── layout.tsx           # Auth layout (centered card)
│   ├── (dashboard)/             # Protected route group
│   │   ├── dashboard/page.tsx
│   │   ├── admin/               # Admin panel ({{admin_roles_joined}} only)
│   │   │   ├── users/page.tsx
│   │   │   └── layout.tsx
│   │   ├── prompts/page.tsx
│   │   └── layout.tsx           # Dashboard layout (sidebar + header)
│   ├── auth/
│   │   └── callback/route.ts    # OAuth callback handler
│   ├── api/
│   │   ├── health/route.ts      # Health check endpoint
│   │   ├── admin/
│   │   │   └── users/route.ts   # Admin user management API
│   │   └── llm/
│   │       └── chat/route.ts    # LLM gateway API
│   ├── layout.tsx               # Root layout
│   └── page.tsx                 # Landing / redirect
├── lib/
│   ├── supabase/
│   │   ├── client.ts            # Browser Supabase client
│   │   ├── server.ts            # Server Supabase client
│   │   └── admin.ts             # Service-role Supabase client
│   ├── auth/
│   │   └── middleware.ts        # Auth middleware helpers
│   ├── llm/
│   │   ├── service-client.ts    # HTTP client for Python LLM microservice
│   │   ├── cost-calculator.ts   # Token cost estimation
│   │   └── types.ts             # Shared LLM types
│   └── utils.ts                 # Shared utilities
├── components/
│   ├── ui/                      # Reusable UI primitives
│   └── layout/                  # Layout components (sidebar, header)
├── services/
│   └── llm/                     # Python LLM microservice (FastAPI + Celeste)
│       ├── main.py
│       ├── requirements.txt
│       └── .env
├── middleware.ts                 # Next.js middleware (route protection)
├── launchblocks/                # Launchblocks-generated files (do not edit)
│   ├── LaunchBlocks_implementation.md
│   ├── specs/
│   ├── schemas/migrations/
│   └── references/
└── .env.local                   # Environment variables (not committed)
```

---

## 1.3 Environment Variables

Create a `.env.local` file at the project root. Never commit this file.

### Required Variables

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# LLM Provider API Keys
{{#each providers_display}}
{{this.env_var}}={{this.env_placeholder}}
{{/each}}
# LLM Service
LLM_SERVICE_URL=http://localhost:8000

# App Configuration
NEXT_PUBLIC_APP_NAME={{app_name}}
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### .env.example

Create `.env.example` with placeholder values (committed to repo) so collaborators know what variables are required. Use the exact same keys with empty or placeholder values.

### Variable Access Rules

| Prefix | Accessible From | Use For |
|---|---|---|
| `NEXT_PUBLIC_*` | Client + Server | Supabase URL, anon key, app name |
| No prefix | Server only | Service role key, LLM API keys |

**Never expose `SUPABASE_SERVICE_ROLE_KEY` or LLM API keys to the client.** All LLM calls must go through server-side API routes.

---

## 1.4 Supabase Client Initialization

Create three Supabase client utilities. Each serves a different context.

### Browser Client (`lib/supabase/client.ts`)

Used in Client Components. Creates a single shared instance.

```typescript
import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

### Server Client (`lib/supabase/server.ts`)

Used in Server Components, Server Actions, and Route Handlers. Manages cookies for session continuity.

```typescript
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll(); },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            cookieStore.set(name, value, options)
          );
        },
      },
    }
  );
}
```

### Admin Client (`lib/supabase/admin.ts`)

Used only on the server for privileged operations (bypasses RLS). Used for LLM audit logging and admin operations.

```typescript
import { createClient } from '@supabase/supabase-js';

export function createAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    { auth: { autoRefreshToken: false, persistSession: false } }
  );
}
```

---

## 1.5 Health Check Endpoint

Implement `GET /api/health` to verify the deployment is live and can reach Supabase.

### Specification

| Field | Value |
|---|---|
| Method | GET |
| Path | `/api/health` |
| Auth | None (public) |
| Response | JSON |

### Response Format

```json
{
  "status": "ok",
  "app": "{{app_name}}",
  "timestamp": "2025-01-01T00:00:00.000Z",
  "supabase": "connected"
}
```

### Implementation Notes

- Attempt a lightweight Supabase query (e.g., `SELECT 1` or read from the `roles` table) using the anon key
- If the Supabase check fails, return `"supabase": "error"` with a 503 status
- Do not expose internal error details in production
- Keep the response under 100ms if possible

---

## 1.6 Vercel Configuration

### vercel.json (optional)

Most Next.js projects on Vercel require no configuration file. If needed:

```json
{
  "framework": "nextjs",
  "regions": ["iad1"]
}
```

### Environment Variables in Vercel

Set all variables from `.env.local` in Vercel Dashboard under Settings > Environment Variables. Apply them to Production, Preview, and Development environments.

### Build Settings

| Setting | Value |
|---|---|
| Build Command | `next build` (auto-detected) |
| Output Directory | `.next` (auto-detected) |
| Install Command | `npm install` (auto-detected) |
| Node.js Version | 18.x or 20.x |

### Python LLM Microservice Deployment

The Python LLM microservice (`services/llm/`) runs separately from the Next.js app. Deploy it to a Python-friendly platform:

| Platform | Notes |
|---|---|
| Railway | Easiest — auto-detects Python, set env vars in dashboard |
| Fly.io | Good for low-latency, supports regions |
| Google Cloud Run | Serverless, scales to zero |
| Render | Simple deploy from Git |

After deploying, set `LLM_SERVICE_URL` in the Next.js environment to point to the deployed Python service URL (e.g., `https://your-llm-service.up.railway.app`).

For local development, run the Python service with `uvicorn main:app --reload` from `services/llm/` and use `LLM_SERVICE_URL=http://localhost:8000`.

---

## 1.7 Deployment Verification

After deploying to Vercel, verify the following in order:

1. **Health check**: `GET https://your-app.vercel.app/api/health` returns `{"status": "ok", "supabase": "connected"}`
2. **Landing page**: The root URL loads without errors
3. **Auth pages**: `/login` and `/signup` render correctly
4. **Supabase redirect**: Set the Supabase Dashboard Site URL to your Vercel domain
5. **Auth callback**: Add `https://your-app.vercel.app/auth/callback` to Supabase redirect allow-list
6. **Signup flow**: Create a test account; confirm profile row appears in `user_profiles`
7. **Admin promotion**: Manually promote the first user to `{{owner_role}}` in Supabase SQL Editor:
   ```sql
   UPDATE public.user_profiles
   SET role = '{{owner_role}}', status = 'approved'
   WHERE email = 'your-email@example.com';
   ```
8. **Protected routes**: Confirm unauthenticated users are redirected away from `/dashboard`

---

## 1.8 Error Handling Baseline

Establish these patterns from the start:

- All API routes return consistent JSON: `{ data, error }` for success, `{ error: string }` for failure
- Use appropriate HTTP status codes: 200, 201, 400, 401, 403, 404, 500
- Never leak stack traces or internal details in production responses
- Log errors server-side with enough context to debug (user ID, endpoint, timestamp)
- Client-side: display user-friendly toast messages for errors, not raw error strings

---

## Implementation Tasks

Complete these tasks in order. Each task builds on the previous ones.

### Task 1.1: Initialize Next.js Project
Create a new Next.js project with App Router, TypeScript, and Tailwind CSS. Use the `src/` directory convention.
**Verify:** Run `npm run dev` and confirm the default Next.js page loads at `http://localhost:3000`.

### Task 1.2: Install Core Dependencies
Install all required packages: `@supabase/supabase-js`, `@supabase/ssr`, `zod`, and initialize `shadcn/ui` with `npx shadcn@latest init`. Set up the `services/llm/` Python directory with a `requirements.txt` containing `celeste-ai`, `fastapi`, `uvicorn`.
**Verify:** Run `npm ls @supabase/supabase-js @supabase/ssr zod` and confirm all are installed. Confirm `services/llm/requirements.txt` exists.

### Task 1.3: Create Supabase Client Utilities
Create three client files: `lib/supabase/client.ts` (browser), `lib/supabase/server.ts` (server with cookies), and `lib/supabase/admin.ts` (service role). Follow the patterns in Section 1.4.
**Verify:** Import each client in a test file and confirm TypeScript compiles without errors.

### Task 1.4: Configure Environment Variables
Create `.env.local` with all required variables (Supabase URL, keys, LLM provider keys, app config). Create `.env.example` with placeholder values. Add `.env.local` to `.gitignore`.
**Verify:** Confirm `.env.example` exists with all required keys and `.env.local` is gitignored.

### Task 1.5: Create Health Check Endpoint
Implement `GET /api/health` that returns `{ status: "ok", app: "{{app_name}}", timestamp, supabase: "connected" }`. Include a lightweight Supabase connectivity check.
**Verify:** Run `curl http://localhost:3000/api/health` and confirm it returns a valid JSON response with `"status": "ok"`.

### Task 1.6: Set Up Next.js Middleware
Create `middleware.ts` at the project root that refreshes the Supabase session on every request, protects `/dashboard/*` and `/admin/*` routes, and redirects unauthenticated users to `/login`.
{{#if require_approval}}
Include logic to redirect authenticated but `pending_approval` users to `/pending-approval`.
{{/if}}
**Verify:** Navigate to `/dashboard` without a session and confirm you are redirected to `/login`.

### Task 1.7: Create Root Layout and Landing Page
Set up `app/layout.tsx` with HTML structure, fonts, and Tailwind. Create `app/page.tsx` as a landing page or redirect to `/dashboard`.
**Verify:** The app loads without errors and the root layout renders correctly.

### Task 1.8: Configure Vercel Deployment
Set all environment variables in the Vercel dashboard. Deploy the project and verify the health check endpoint.
**Verify:** `GET https://your-app.vercel.app/api/health` returns `{"status": "ok", "supabase": "connected"}`.

---

## Test Specifications

### Unit Tests
- [ ] Browser Supabase client initializes without throwing
- [ ] Server Supabase client initializes without throwing
- [ ] Admin Supabase client initializes without throwing
- [ ] Health check endpoint returns correct JSON shape (`status`, `app`, `timestamp`, `supabase`)
- [ ] Health check returns 503 when Supabase is unreachable

### Integration Tests
- [ ] Health check endpoint reaches Supabase and returns `"supabase": "connected"`
- [ ] Middleware redirects unauthenticated requests from `/dashboard` to `/login`
- [ ] Middleware allows unauthenticated access to `/login` and `/signup`
{{#if require_approval}}
- [ ] Middleware redirects `pending_approval` users to `/pending-approval`
{{/if}}
- [ ] Environment variables are correctly loaded in both server and client contexts

### E2E Tests
- [ ] Application starts successfully with `npm run dev`
- [ ] Health check endpoint is accessible at `/api/health`
- [ ] Root page loads without JavaScript errors
- [ ] Protected routes redirect to login when not authenticated
- [ ] Public routes (login, signup) are accessible without authentication
