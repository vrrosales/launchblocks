# LaunchBlocks_implementation.md — {{app_name}}

> Generated by **Launchblocks CLI**. This is the master specification for {{app_name}}.
> An AI coding tool should be able to implement the entire project from this single file
> plus the SQL migrations in `schemas/migrations/` and reference docs in `references/`.

---

## 1. Project Overview

**{{app_name}}** is a full-stack web application built with the Launchblocks stack. It provides user authentication, role-based access control, an LLM gateway with provider abstraction, prompt template management, and a full audit trail for every LLM call{{#if include_billing}}, plus Stripe-powered billing and subscription management{{/if}}.

- **App slug:** `{{slug}}`
- **Hosting:** Vercel (Next.js App Router)
- **Database & Auth:** Supabase (PostgreSQL + Supabase Auth)
- **LLM Providers:** {{#each providers_display}}{{this.name}}{{#unless @last}}, {{/unless}}{{/each}}
- **Roles:** {{role_names_joined}}
- **Owner role:** `{{owner_role}}` ({{owner_role_display}})
- **Default signup role:** `{{default_role}}` ({{default_role_display}})
{{#if require_approval}}
- **Signup approval:** Required — new users start as `pending_approval` and must be approved by an admin
{{else}}
- **Signup approval:** Not required — new users are immediately `approved`
{{/if}}

---

## 2. Technology Stack

| Layer | Technology | Purpose |
|---|---|---|
| Framework | Next.js 14+ (App Router) | Server/client rendering, API routes |
| Hosting | Vercel | Deployment, serverless functions, edge |
| Database | Supabase (PostgreSQL) | Relational data, Row Level Security |
| Auth | Supabase Auth | Email/password, OAuth, magic link |
| Styling | Tailwind CSS + shadcn/ui | Utility-first CSS, accessible components |
| State | React Server Components + `nuqs` | Server-first state, URL search params |
| Python Microservice | Python 3.12+ / FastAPI | LLM call processing via Celeste |
| LLM SDK | Celeste AI (`celeste-ai`) | Unified SDK for {{#each providers_display}}{{this.name}}{{#unless @last}}, {{/unless}}{{/each}} |
| Validation | Zod | Runtime schema validation |
| ORM | Supabase JS Client | Type-safe database queries |

### Environment Variables

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=<your-project-url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>

# LLM Providers
{{#each providers_display}}
{{this.env_var}}=<{{this.env_placeholder}}>
{{/each}}
# LLM Service
LLM_SERVICE_URL=http://localhost:8000
{{#if include_billing}}

# Stripe
STRIPE_SECRET_KEY=<sk_test_your-stripe-key>
STRIPE_WEBHOOK_SECRET=<whsec_your-webhook-secret>
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=<pk_test_your-stripe-key>
{{/if}}

# App
NEXT_PUBLIC_APP_NAME={{app_name}}
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

See `schemas/sample-env.md` for where to find each value.

---

## 3. Architecture Overview

```
┌──────────────────────────────────────────────────────────┐
│               Next.js App (Vercel)                        │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌────────────────────┐     │
│  │  Auth     │  │  Admin   │  │  LLM Chat /        │     │
│  │  Pages    │  │  Panel   │  │  Prompt Playground  │     │
│  └────┬─────┘  └────┬─────┘  └────────┬───────────┘     │
│       │              │                 │                  │
│       ▼              ▼                 ▼                  │
│  ┌──────────┐  ┌──────────┐  ┌────────────────────┐     │
│  │ /api/auth │  │/api/admin│  │ /api/llm/chat       │     │
│  └────┬─────┘  └────┬─────┘  │  ├─ Auth check      │     │
│       │              │        │  ├─ Template resolve │     │
│       │              │        │  ├─ Variable interp. │     │
│       │              │        │  ├─ Proxy to Python  │     │
│       │              │        │  └─ Audit logging    │     │
│       │              │        └────────┬───────────┘     │
└───────┼──────────────┼─────────────────┼────────────────┘
        │              │                 │
        ▼              ▼                 ▼
┌──────────────┐ ┌──────────────┐ ┌───────────────────────┐
│   Supabase   │ │   Supabase   │ │ Python Microservice    │
│     Auth     │ │   Database   │ │ (FastAPI + Celeste AI) │
│              │ │  (Postgres)  │ │                         │
│  - Signup    │ │              │ │  POST /generate         │
│  - Login     │ │  - roles     │ │  POST /stream           │
│  - OAuth     │ │  - profiles  │ │  GET  /health           │
│  - Reset     │ │  - prompts   │ │                         │
│              │ │  - audit_log │ │  Celeste AI SDK →       │
│              │ │              │ │  [{{#each providers_display}}{{this.name}}{{#unless @last}}, {{/unless}}{{/each}}] │
└──────────────┘ └──────────────┘ └───────────────────────┘
```

### Request Flow: LLM Gateway

1. Client sends POST to `/api/llm/chat` with `{ template_slug, variables }` or ad-hoc messages
2. Next.js middleware validates session via Supabase Auth
3. Next.js API checks user status is `approved` and role has LLM access
4. Next.js loads prompt template from `prompt_templates` table by slug
5. Next.js interpolates variables into the prompt template
6. Next.js forwards the resolved prompt to the Python microservice (`POST /generate` or `POST /stream`)
7. Python service calls the provider via Celeste AI SDK ({{#each providers_display}}{{this.id}}{{#unless @last}}, {{/unless}}{{/each}})
8. Python service returns the response (or streams chunks) to Next.js
9. Next.js writes audit entry to `llm_audit_log` (tokens, cost, latency, status)
10. Next.js returns the response to the client

---

## 4. Roles & Permissions

### Role Definitions

| Role | Display Name | Type | Permissions |
|---|---|---|---|
{{#each role_permission_summary}}
| `{{this.name}}` | {{this.display_name}} | {{#if this.is_owner}}Owner{{else}}{{#if this.is_default}}Default{{else}}Standard{{/if}}{{/if}} | {{#if this.has_permissions}}{{this.permissions_list}}{{else}}_(none)_{{/if}} |
{{/each}}

### Permission Reference

| Permission | Description |
|---|---|
| `manage_users` | View user list, approve/suspend accounts |
| `manage_roles` | Change user roles |
| `manage_prompts` | Create/edit/delete prompt templates |
| `view_audit_log` | View LLM audit trail and cost data |
| `export_audit_log` | Export audit data as CSV |
| `manage_settings` | Modify application settings |
| `manage_providers` | Add/edit LLM provider configs |

### LLM Access

Roles with LLM gateway access: **{{llm_access_roles_joined}}**
{{#unless all_roles_have_llm}}

Roles without LLM access will receive a 403 when calling the gateway endpoint.
{{/unless}}

### Admin Roles

Roles with admin panel access: **{{admin_roles_joined}}**

---

## 5. Signup & Approval Behavior

When a new user signs up:

1. Supabase Auth creates the `auth.users` record
2. A database trigger (`handle_new_user`) auto-creates a `user_profiles` row
3. The profile is assigned role `{{default_role}}` ({{default_role_display}})
{{#if require_approval}}
4. The profile status is set to `pending_approval`
5. The user sees a "pending approval" screen and cannot access the app
6. An admin (roles: {{admin_roles_joined}}) must approve the user via the admin panel
7. Upon approval, status changes to `approved` and the user gains full access

**Important:** All protected pages and API routes must check `status = 'approved'` in addition to authentication. A logged-in user with `pending_approval` status should only see the pending screen.
{{else}}
4. The profile status is set to `approved`
5. The user gains immediate access to the application

**Note:** Even though approval is not required, the `status` column still exists. Admin users can still suspend accounts by setting status to `suspended`.
{{/if}}

---

## 6. Module 1: Project Setup

### Goal
Scaffold the Next.js project, configure Supabase client, set up environment variables, and create a health check endpoint.

### Tasks

1. **Initialize Next.js** with App Router, TypeScript, Tailwind CSS, and `src/` directory
2. **Install dependencies:**
   - `@supabase/supabase-js` and `@supabase/ssr` for auth/database
   - `zod` for validation
   - `shadcn/ui` for UI components (run `npx shadcn@latest init`)
   - Note: Individual LLM provider SDKs are **not** needed in the Next.js app. LLM calls are handled by the Python microservice (Celeste AI SDK).
   - Set up `services/llm/` Python directory with `celeste-ai`, `fastapi`, `uvicorn` dependencies
3. **Create Supabase client utilities:**
   - `src/lib/supabase/client.ts` — browser client
   - `src/lib/supabase/server.ts` — server client (cookies-based)
   - `src/lib/supabase/middleware.ts` — middleware client
4. **Create `.env.local`** from the environment variables listed above
5. **Create health check** at `GET /api/health` returning `{ status: "ok", timestamp }`
6. **Create middleware** at `src/middleware.ts` that:
   - Refreshes the Supabase session on every request
   - Protects `/dashboard/*` and `/admin/*` routes (redirect to `/login` if no session)
{{#if require_approval}}
   - Redirects authenticated but `pending_approval` users to `/pending`
{{/if}}

### File Structure

```
src/
  app/
    layout.tsx            # Root layout with Supabase provider
    page.tsx              # Landing / redirect to dashboard
    api/
      health/route.ts     # Health check endpoint
  lib/
    supabase/
      client.ts           # Browser Supabase client
      server.ts           # Server Supabase client
      middleware.ts        # Middleware Supabase client
  middleware.ts            # Next.js middleware
```

---

## 7. Module 2: Database

### Goal
Run the SQL migrations to create all tables, RLS policies, functions, and seed data.

### Migrations

Run these SQL files **in order** in the Supabase SQL editor (Dashboard > SQL Editor):

1. `schemas/migrations/001_roles_and_permissions.sql` — Roles table, permissions table, seed data, helper functions
2. `schemas/migrations/002_users_and_profiles.sql` — User profiles table with auto-creation trigger
3. `schemas/migrations/003_prompt_templates.sql` — Prompt templates table for LLM prompts
4. `schemas/migrations/004_llm_audit_log.sql` — Audit log table and summary view

### Database Schema

#### `public.roles`
| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) | Auto-generated |
| name | text (UNIQUE) | Role identifier: {{role_names_joined}} |
| display_name | text | Human-readable name |
| is_owner_role | boolean | `true` only for `{{owner_role}}` |
| is_default_role | boolean | `true` only for `{{default_role}}` |
| is_system | boolean | System roles cannot be deleted |
| sort_order | integer | Display ordering |

#### `public.role_permissions`
| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) | Auto-generated |
| role_id | uuid (FK) | References `roles.id` |
| permission | text | One of the 7 permission types |

#### `public.user_profiles`
| Column | Type | Notes |
|---|---|---|
| id | uuid (PK, FK) | References `auth.users.id` |
| email | text | User email |
| full_name | text | Display name |
| avatar_url | text | Profile picture URL |
| role | text (FK) | References `roles.name`, default: `{{default_role}}` |
| status | text | `pending_approval`, `approved`, or `suspended` |
| metadata | jsonb | Extensible metadata |

#### `public.prompt_templates`
| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) | Auto-generated |
| slug | text (UNIQUE) | URL-safe identifier |
| name | text | Display name |
| description | text | What this prompt does |
| system_prompt | text | System message content |
| user_prompt_template | text | User message with `\{{variable}}` placeholders |
| model | text | e.g., `gpt-4o`, `claude-sonnet-4-6` |
| provider | text | `{{llm_providers.[0]}}` default |
| temperature | numeric(3,2) | 0.0 to 2.0 |
| max_tokens | integer | 1 to 128000 |
| is_active | boolean | Soft delete |
| version | integer | Incremented on edit |
| created_by | uuid (FK) | References `user_profiles.id` |

#### `public.llm_audit_log`
| Column | Type | Notes |
|---|---|---|
| id | uuid (PK) | Auto-generated |
| user_id | uuid (FK) | Who made the request |
| prompt_template_id | uuid (FK) | Which template was used (nullable) |
| provider | text | Which LLM provider |
| model | text | Which model |
| input_tokens | integer | Tokens sent |
| output_tokens | integer | Tokens received |
| total_tokens | integer | Generated column (input + output) |
| estimated_cost | numeric(10,6) | Cost in USD |
| latency_ms | integer | Response time |
| status | text | `success`, `error`, or `timeout` |
| error_message | text | Error details if failed |
| request_metadata | jsonb | Additional context |

#### `public.llm_audit_summary` (VIEW)
Aggregates audit data by day, provider, and model. Includes request counts, total tokens, total cost, average latency, and error counts.

### Helper Functions

- `has_permission(user_id, permission)` — Check if a user has a specific permission via their role
- `has_role(user_id, role_name)` — Check if a user has a specific role
- `handle_new_user()` — Trigger function that creates a `user_profiles` row on signup

### TypeScript Types

Generate types from Supabase with: `npx supabase gen types typescript --project-id <id> > src/lib/supabase/database.types.ts`

---

## 8. Module 3: Authentication

### Goal
Implement signup, login, logout, and password reset flows using Supabase Auth.

### Screens

| Route | Page | Description |
|---|---|---|
| `/login` | Login | Email/password login form |
| `/signup` | Signup | Registration form (name, email, password) |
| `/forgot-password` | Forgot Password | Email input, sends reset link |
| `/auth/reset-password` | Reset Password | New password form (accessed via email link) |
| `/auth/callback` | Auth Callback | Handles OAuth redirects and email confirmations |
{{#if require_approval}}
| `/pending` | Pending Approval | Shown to users with `pending_approval` status |
{{/if}}

### Implementation Notes

- Use `@supabase/ssr` for server-side auth in Next.js App Router
- Create an auth callback route handler at `app/auth/callback/route.ts` to exchange codes for sessions
- All auth pages should be public (no middleware redirect)
- After successful login, redirect to `/dashboard`
{{#if require_approval}}
- After successful signup, redirect to `/pending` (user is `pending_approval`)
- The `/pending` page should show a message explaining the user is awaiting approval
- Middleware must check `user_profiles.status` and redirect non-approved users to `/pending`
{{else}}
- After successful signup, redirect to `/dashboard` (user is immediately `approved`)
{{/if}}
- See `references/supabase-auth-patterns.md` for complete code examples

### Auth Middleware Logic

```typescript
// Pseudocode for middleware.ts
1. Refresh Supabase session
2. If no session AND protected route → redirect to /login
3. If session exists:
   a. Fetch user_profiles.status
   b. If status === 'suspended' → sign out, redirect to /login with error
{{#if require_approval}}
   c. If status === 'pending_approval' AND not on /pending → redirect to /pending
   d. If status === 'approved' AND on /pending → redirect to /dashboard
{{/if}}
4. If route starts with /admin → check user has admin role ({{admin_roles_joined}})
```

---

## 9. Module 4: User Management

### Goal
Build an admin panel for managing users, roles, and {{#if require_approval}}approving signups{{else}}account status{{/if}}.

### Screens

| Route | Page | Access |
|---|---|---|
| `/admin` | Admin Dashboard | {{admin_roles_joined}} |
| `/admin/users` | User List | `manage_users` permission |
| `/admin/users/[id]` | User Detail | `manage_users` permission |
{{#if require_approval}}
| `/admin/approvals` | Pending Approvals | `manage_users` permission |
{{/if}}

### API Routes

| Method | Route | Permission | Description |
|---|---|---|---|
| GET | `/api/admin/users` | `manage_users` | List all users (paginated, filterable) |
| GET | `/api/admin/users/[id]` | `manage_users` | Get single user with role details |
| PATCH | `/api/admin/users/[id]` | `manage_users` | Update user role or status |
{{#if require_approval}}
| POST | `/api/admin/users/[id]/approve` | `manage_users` | Approve a pending user |
{{/if}}
| POST | `/api/admin/users/[id]/suspend` | `manage_users` | Suspend a user |
| POST | `/api/admin/users/[id]/reactivate` | `manage_users` | Reactivate a suspended user |

### User List Features

- Paginated table with columns: Name, Email, Role, Status, Created
- Filter by role ({{role_names_joined}})
- Filter by status (approved{{#if require_approval}}, pending_approval{{/if}}, suspended)
- Search by name or email
{{#if require_approval}}
- Quick-action button to approve pending users
{{/if}}
- Click row to navigate to user detail

### User Detail Features

- Display profile information
- Role dropdown (only `{{owner_role}}` can change roles, other admins can only change non-admin users)
- Status toggle (approve / suspend / reactivate)
- Activity summary (recent LLM calls from audit log)

### Permission Checks

Every admin API route must:
1. Verify the session is valid
2. Check `user_profiles.status = 'approved'`
3. Check the user has the required permission via `has_permission()`
4. Return 403 if any check fails

---

## 10. Module 5: LLM Gateway

### Goal
Build a two-service LLM gateway: a **Python microservice** (FastAPI + Celeste AI SDK) that handles all LLM provider calls, and a **Next.js proxy route** that handles auth, template resolution, and audit logging.

### Supported Providers

{{#each providers_display}}
- **{{this.name}}** (`{{this.id}}`)
{{/each}}

### Two-Service Architecture

```
Next.js (Vercel)                     Python Microservice
├── /api/llm/chat                    ├── FastAPI
│   ├── Auth check                   ├── Celeste AI SDK
│   ├── Template resolution          ├── POST /generate
│   ├── Variable interpolation       ├── POST /stream
│   ├── Forward to Python svc ──→    └── GET /health
│   ├── Receive response
│   └── Write audit log
```

- **Next.js** owns auth, Supabase access (template DB, audit log), and orchestration
- **Python service** owns LLM calls via Celeste — no direct DB access needed

### API Route

**POST `/api/llm/chat`**

Request body (template-based):
```json
{
  "template_slug": "summarize-article",
  "variables": { "article_text": "...", "max_length": "3 sentences" },
  "stream": false
}
```

Request body (ad-hoc):
```json
{
  "messages": [
    { "role": "system", "content": "You are a helpful assistant." },
    { "role": "user", "content": "Explain quantum computing." }
  ],
  "provider": "{{providers_display.[0].id}}",
  "model": "gpt-4o",
  "temperature": 0.7,
  "max_tokens": 1024,
  "stream": false
}
```

Success response:
```json
{
  "content": "The LLM response text...",
  "provider": "{{llm_providers.[0]}}",
  "model": "gpt-4o",
  "usage": { "input_tokens": 150, "output_tokens": 320, "total_tokens": 470 },
  "estimated_cost": 0.003215,
  "latency_ms": 1230,
  "audit_id": "uuid"
}
```

### Python Microservice

The Python service exposes three endpoints. It uses the Celeste AI SDK to call any configured provider.

- **POST `/generate`** — Non-streaming LLM call. Accepts `{ provider, model, messages, temperature, max_tokens }`, returns `{ content, usage, latency_ms }`.
- **POST `/stream`** — Streaming LLM call (SSE). Same request shape, returns `text/event-stream` with content chunks.
- **GET `/health`** — Returns `{ "status": "ok" }`.

> **Celeste SDK version note:** Pin `celeste-ai>=0.10,<1.0` in `requirements.txt`. Refer to the Celeste AI SDK documentation for current API methods — do not hardcode SDK internals.

### File Structure

```
services/llm/
  main.py                          # FastAPI app with /generate, /stream, /health
  requirements.txt                 # celeste-ai, fastapi, uvicorn

src/lib/llm/
  service-client.ts                # HTTP client for the Python microservice
  cost-calculator.ts               # Token cost estimation
  types.ts                         # Shared TypeScript types

src/app/api/llm/chat/
  route.ts                         # POST handler (auth → template → proxy → audit)
```

### Access Control

The Next.js route must enforce:
1. User is authenticated and `approved`
2. User's role is in the LLM access list: {{llm_access_roles_joined}}
3. The prompt template exists and `is_active = true` (for template-based calls)
4. Return 403 with a clear error if any check fails

### Audit Logging

After every LLM call (success or failure), the **Next.js route** inserts a row into `llm_audit_log`:
- Use the **service role** client for inserts (bypasses RLS)
- Calculate `estimated_cost` using the pricing formula in `references/llm-pricing-table.md`
- Record `latency_ms` from request start to response complete
- On error, set `status = 'error'` and store the error message

---

## 11. Module 6: Prompt Management

### Goal
Build CRUD for prompt templates with versioning and variable interpolation.

### Screens

| Route | Page | Access |
|---|---|---|
| `/dashboard/prompts` | Prompt List | All approved users (read-only for non-admins) |
| `/dashboard/prompts/new` | Create Prompt | `manage_prompts` permission |
| `/dashboard/prompts/[id]` | Edit Prompt | `manage_prompts` permission |
| `/dashboard/prompts/[id]/test` | Test Prompt | `manage_prompts` permission |

### API Routes

| Method | Route | Permission | Description |
|---|---|---|---|
| GET | `/api/prompts` | Authenticated + approved | List active templates |
| GET | `/api/prompts/[id]` | Authenticated + approved | Get single template |
| POST | `/api/prompts` | `manage_prompts` | Create new template |
| PUT | `/api/prompts/[id]` | `manage_prompts` | Update template (bumps version) |
| DELETE | `/api/prompts/[id]` | `manage_prompts` | Soft-delete (set `is_active = false`) |
| POST | `/api/prompts/[id]/test` | `manage_prompts` | Test-run a prompt with sample variables |

### Prompt Template Variables

The `user_prompt_template` field supports double-curly-brace variables: `\{{variable_name}}`.

When the gateway processes a prompt, it replaces each variable with the value from the request's `variables` object. Example:

- Template: `Summarize this text: \{{text}}`
- Request variables: `{ "text": "Lorem ipsum..." }`
- Resolved: `Summarize this text: Lorem ipsum...`

### Versioning

- Every update to a prompt template increments the `version` column
- The audit log references `prompt_template_id`, so historical data is preserved
- Display the current version in the prompt editor UI

### Prompt Editor UI

- **Slug** — auto-generated from name, editable, must be unique
- **Name** and **Description** — text fields
- **System Prompt** — textarea for the system message
- **User Prompt Template** — textarea with variable highlighting
- **Provider** dropdown — {{#each providers_display}}{{this.id}}{{#unless @last}}, {{/unless}}{{/each}}
- **Model** dropdown — populated based on selected provider
- **Temperature** slider — 0.0 to 2.0
- **Max Tokens** input — 1 to 128000
- **Active** toggle — deactivated prompts are hidden from non-admin users

---

## 12. Module 7: LLM Audit Trail

### Goal
Build a dashboard for viewing, filtering, and exporting LLM usage data.

### Screens

| Route | Page | Access |
|---|---|---|
| `/dashboard/usage` | My Usage | All approved users (own data only) |
| `/admin/audit` | Audit Dashboard | `view_audit_log` permission |
| `/admin/audit/export` | Export | `export_audit_log` permission |

### API Routes

| Method | Route | Permission | Description |
|---|---|---|---|
| GET | `/api/audit` | `view_audit_log` | List all audit entries (paginated) |
| GET | `/api/audit/summary` | `view_audit_log` | Aggregated stats from `llm_audit_summary` view |
| GET | `/api/audit/export` | `export_audit_log` | Download CSV of audit data |
| GET | `/api/audit/my-usage` | Authenticated + approved | Current user's own usage |

### Audit Dashboard Features

- **Summary cards:** Total requests, total tokens, total cost, average latency (for selected period)
- **Chart:** Daily usage over time (requests and cost)
- **Table:** Paginated list of individual LLM calls with columns:
  - Timestamp, User, Prompt Template, Provider, Model, Tokens (in/out), Cost, Latency, Status
- **Filters:** Date range, provider, model, user, status
- **Export:** Download filtered results as CSV

### My Usage Page

Same as audit dashboard but filtered to the current user. Does not require `view_audit_log` permission — users can always see their own usage.

{{#if include_billing}}
---

## 13. Module 8: Billing

### Goal
Integrate Stripe for {{#if is_billing_both}}subscription plans and usage-based billing{{else}}{{#if is_subscription}}subscription-based billing with tiered plans{{else}}usage-based billing per LLM call{{/if}}{{/if}}.

### Screens

| Route | Page | Access |
|---|---|---|
| `/dashboard/billing` | Billing Overview | Any authenticated user |
| `/dashboard/billing/plans` | Plan Selection | Any authenticated user |
| `/admin/billing` | Billing Admin | `manage_settings` permission |

### API Routes

| Method | Route | Description |
|---|---|---|
| POST | `/api/billing/checkout` | Create Stripe Checkout Session |
| POST | `/api/billing/portal` | Create Stripe Customer Portal session |
| GET | `/api/billing/subscription` | Get current user's subscription |
| GET | `/api/billing/plans` | List active plans |
| POST | `/api/billing/webhook` | Stripe webhook handler |
{{#if is_usage_based}}
| GET | `/api/billing/usage` | Get current user's usage |
{{/if}}

### Database Tables

- `subscription_plans` — Plan definitions with features, limits, and Stripe Price IDs
- `user_subscriptions` — User-to-plan mapping with Stripe subscription data
- `billing_events` — Stripe event log for idempotent webhook handling
{{#if is_usage_based}}
- `usage_records` — Per-period usage tracking for metered billing
{{/if}}

### Implementation Notes

- Stripe SDK (`stripe`) handles all payment operations
- Webhook handler verifies signatures and processes events idempotently
- Plan gating restricts LLM calls and prompt creation based on plan limits
- Customer Portal provides self-service subscription management
- See `specs/08-billing.md` for complete implementation tasks and test specifications

{{/if}}
---

## {{#if include_billing}}14{{else}}13{{/if}}. API Response Format

All API routes must return consistent JSON shapes.

### Success Response

```json
{
  "success": true,
  "data": { ... }
}
```

### Success Response (paginated)

```json
{
  "success": true,
  "data": [ ... ],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 142,
    "total_pages": 8
  }
}
```

### Error Response

```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "You do not have permission to perform this action."
  }
}
```

### Standard Error Codes

| Code | HTTP Status | When |
|---|---|---|
| `UNAUTHORIZED` | 401 | No valid session |
| `FORBIDDEN` | 403 | Valid session but insufficient permissions |
| `NOT_FOUND` | 404 | Resource does not exist |
| `VALIDATION_ERROR` | 422 | Request body fails Zod validation |
| `RATE_LIMITED` | 429 | Too many requests |
| `INTERNAL_ERROR` | 500 | Unexpected server error |
| `LLM_ERROR` | 502 | LLM provider returned an error |
| `LLM_TIMEOUT` | 504 | LLM provider timed out |

---

## {{#if include_billing}}15{{else}}14{{/if}}. Implementation Order

Modules must be implemented in this order due to dependencies:

```
Module 1: Project Setup
    │
    ▼
Module 2: Database (run SQL migrations)
    │
    ▼
Module 3: Authentication
    │
    ├──────────────────┐
    ▼                  ▼
Module 4:          Module 5:
User Management    LLM Gateway
    │                  │
    │              ┌───┴───┐
    │              ▼       ▼
    │          Module 6: Module 7:
    │          Prompts   Audit
    │              │       │
    └──────────────┴───────┘
              │
              ▼
{{#if include_billing}}
          Module 8:
          Billing
              │
              ▼
{{/if}}
          COMPLETE
```

### Implementation Sequence

1. **Module 1 — Project Setup** — No dependencies. Scaffold the project, install packages, configure clients.
2. **Module 2 — Database** — Depends on Module 1 (needs Supabase config). Run all {{#if include_billing}}5{{else}}4{{/if}} SQL migrations in order.
3. **Module 3 — Authentication** — Depends on Modules 1+2. Build auth UI and callback routes.
4. **Module 4 — User Management** — Depends on Module 3. Build admin panel for user CRUD.
5. **Module 5 — LLM Gateway** — Depends on Module 3. Set up the Python LLM microservice (FastAPI + Celeste) and the Next.js proxy route.
6. **Module 6 — Prompt Management** — Depends on Module 5. Build prompt CRUD and test runner.
7. **Module 7 — LLM Audit Trail** — Depends on Module 5. Build audit dashboard and export.
{{#if include_billing}}
8. **Module 8 — Billing** — Depends on Modules 5+6. Integrate Stripe billing, plan gating, and subscription management.
{{/if}}

### Spec Structure

Each module spec in `specs/` contains three sections:

1. **Feature specifications** — Requirements, data models, API contracts, and UI descriptions
2. **Implementation Tasks** — Numbered, ordered tasks to complete in sequence. Each task starts with an action verb and includes a **Verify** step describing how to confirm completion.
3. **Test Specifications** — Concrete test definitions organized into Unit, Integration, and E2E categories with checkboxes.

Start with Module 1 Task 1.1, then proceed through each task in order. After completing all tasks in a module, run the test specifications to verify correctness before moving to the next module.

### Verification Checklist

After each module, verify:

- [ ] **Module 1:** `GET /api/health` returns 200, Supabase client connects, middleware redirects work
- [ ] **Module 2:** All {{#if include_billing}}5{{else}}4{{/if}} migrations run without errors, `roles` table has {{role_names_joined}}
- [ ] **Module 3:** Can sign up, log in, log out, reset password{{#if require_approval}}, pending user sees `/pending`{{/if}}
- [ ] **Module 4:** Admin can list users, change roles{{#if require_approval}}, approve pending users{{/if}}, suspend/reactivate
- [ ] **Module 5:** Python microservice runs (`GET /health` returns ok), Next.js proxy calls provider via Celeste, returns response, logs to audit
- [ ] **Module 6:** Can create/edit/delete prompts, test runner works, versioning increments
- [ ] **Module 7:** Audit dashboard shows data, filters work, CSV export downloads
{{#if include_billing}}
- [ ] **Module 8:** Stripe checkout works, webhooks update subscription, plan gating restricts features
{{/if}}

---

## {{#if include_billing}}16{{else}}15{{/if}}. File Reference

These files are generated by Launchblocks and available in the `launchblocks/` directory:

| File | Purpose |
|---|---|
| `LaunchBlocks_implementation.md` | This file — master specification |
| `launchblocks.config.yaml` | Project configuration (do not edit) |
| `schemas/migrations/001_roles_and_permissions.sql` | Roles + permissions tables and seed data |
| `schemas/migrations/002_users_and_profiles.sql` | User profiles table and signup trigger |
| `schemas/migrations/003_prompt_templates.sql` | Prompt templates table |
| `schemas/migrations/004_llm_audit_log.sql` | Audit log table and summary view |
{{#if include_billing}}
| `schemas/migrations/005_billing.sql` | Billing tables: plans, subscriptions, events |
{{/if}}
| `schemas/sample-env.md` | Environment variable reference |
| `references/supabase-auth-patterns.md` | Supabase Auth code examples |
| `references/vercel-deploy-checklist.md` | Deployment checklist |
| `references/llm-pricing-table.md` | LLM model pricing for cost estimation |
