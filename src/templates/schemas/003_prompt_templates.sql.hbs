-- Migration: 003_prompt_templates
-- Generated by Launchblocks for {{app_name}}
-- Run this in your Supabase SQL editor

-- ============================================================
-- PROMPT TEMPLATES TABLE
-- ============================================================

CREATE TABLE IF NOT EXISTS public.prompt_templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  slug text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  system_prompt text NOT NULL DEFAULT '',
  user_prompt_template text NOT NULL DEFAULT '',
  model text NOT NULL DEFAULT 'gpt-4o',
  provider text NOT NULL DEFAULT '{{llm_providers.[0]}}',
  temperature numeric(3,2) NOT NULL DEFAULT 0.7
    CHECK (temperature >= 0 AND temperature <= 2),
  max_tokens integer NOT NULL DEFAULT 1024
    CHECK (max_tokens > 0 AND max_tokens <= 128000),
  is_active boolean NOT NULL DEFAULT true,
  version integer NOT NULL DEFAULT 1,
  created_by uuid REFERENCES public.user_profiles(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.prompt_templates ENABLE ROW LEVEL SECURITY;

-- All authenticated approved users can read active templates
DROP POLICY IF EXISTS "prompts_select_authenticated" ON public.prompt_templates;
CREATE POLICY "prompts_select_authenticated" ON public.prompt_templates
  FOR SELECT TO authenticated
  USING (
    is_active = true
    AND EXISTS (
      SELECT 1 FROM public.user_profiles
      WHERE id = auth.uid() AND status = 'approved'
    )
  );

-- Users with manage_prompts permission can read all templates (including inactive)
DROP POLICY IF EXISTS "prompts_select_admin" ON public.prompt_templates;
CREATE POLICY "prompts_select_admin" ON public.prompt_templates
  FOR SELECT TO authenticated
  USING (public.has_permission(auth.uid(), 'manage_prompts'));

-- Users with manage_prompts permission can insert/update/delete
DROP POLICY IF EXISTS "prompts_modify_admin" ON public.prompt_templates;
CREATE POLICY "prompts_modify_admin" ON public.prompt_templates
  FOR ALL TO authenticated
  USING (public.has_permission(auth.uid(), 'manage_prompts'));

-- ============================================================
-- INDEXES
-- ============================================================

CREATE INDEX IF NOT EXISTS idx_prompt_templates_slug ON public.prompt_templates(slug);
CREATE INDEX IF NOT EXISTS idx_prompt_templates_provider ON public.prompt_templates(provider);
CREATE INDEX IF NOT EXISTS idx_prompt_templates_active ON public.prompt_templates(is_active);

-- Updated-at trigger
DROP TRIGGER IF EXISTS prompt_templates_updated_at ON public.prompt_templates;
CREATE TRIGGER prompt_templates_updated_at
  BEFORE UPDATE ON public.prompt_templates
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();
