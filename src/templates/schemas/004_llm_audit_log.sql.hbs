-- Migration: 004_llm_audit_log
-- Generated by Launchblocks for {{app_name}}
-- Run this in your Supabase SQL editor

-- ============================================================
-- LLM AUDIT LOG TABLE
-- ============================================================

CREATE TABLE IF NOT EXISTS public.llm_audit_log (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES public.user_profiles(id),
  prompt_template_id uuid REFERENCES public.prompt_templates(id),
  provider text NOT NULL,
  model text NOT NULL,
  input_tokens integer NOT NULL DEFAULT 0,
  output_tokens integer NOT NULL DEFAULT 0,
  total_tokens integer GENERATED ALWAYS AS (input_tokens + output_tokens) STORED,
  estimated_cost numeric(10,6) NOT NULL DEFAULT 0,
  latency_ms integer,
  status text NOT NULL DEFAULT 'success'
    CHECK (status IN ('success', 'error', 'timeout')),
  error_message text,
  request_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.llm_audit_log ENABLE ROW LEVEL SECURITY;

-- Users with view_audit_log permission can read logs
DROP POLICY IF EXISTS "audit_select_admin" ON public.llm_audit_log;
CREATE POLICY "audit_select_admin" ON public.llm_audit_log
  FOR SELECT TO authenticated
  USING (public.has_permission(auth.uid(), 'view_audit_log'));

-- Users can view their own audit entries
DROP POLICY IF EXISTS "audit_select_own" ON public.llm_audit_log;
CREATE POLICY "audit_select_own" ON public.llm_audit_log
  FOR SELECT TO authenticated
  USING (user_id = auth.uid());

-- Only the system (via service role) inserts audit entries
-- Application code should use the service role key for inserts
DROP POLICY IF EXISTS "audit_insert_service" ON public.llm_audit_log;
CREATE POLICY "audit_insert_service" ON public.llm_audit_log
  FOR INSERT TO service_role
  WITH CHECK (true);

-- Also allow authenticated users to insert (for client-side logging)
DROP POLICY IF EXISTS "audit_insert_authenticated" ON public.llm_audit_log;
CREATE POLICY "audit_insert_authenticated" ON public.llm_audit_log
  FOR INSERT TO authenticated
  WITH CHECK (user_id = auth.uid());

-- ============================================================
-- INDEXES
-- ============================================================

CREATE INDEX IF NOT EXISTS idx_llm_audit_user ON public.llm_audit_log(user_id);
CREATE INDEX IF NOT EXISTS idx_llm_audit_provider ON public.llm_audit_log(provider);
CREATE INDEX IF NOT EXISTS idx_llm_audit_created ON public.llm_audit_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_llm_audit_template ON public.llm_audit_log(prompt_template_id);
CREATE INDEX IF NOT EXISTS idx_llm_audit_status ON public.llm_audit_log(status);

-- ============================================================
-- AUDIT SUMMARY VIEW
-- ============================================================

CREATE OR REPLACE VIEW public.llm_audit_summary AS
SELECT
  date_trunc('day', created_at) AS day,
  provider,
  model,
  COUNT(*) AS request_count,
  SUM(input_tokens) AS total_input_tokens,
  SUM(output_tokens) AS total_output_tokens,
  SUM(input_tokens + output_tokens) AS total_tokens,
  SUM(estimated_cost) AS total_cost,
  AVG(latency_ms)::integer AS avg_latency_ms,
  COUNT(*) FILTER (WHERE status = 'error') AS error_count
FROM public.llm_audit_log
GROUP BY day, provider, model
ORDER BY day DESC;
