-- Migration: 001_roles_and_permissions
-- Generated by Launchblocks for {{app_name}}
-- Run this in your Supabase SQL editor

-- ============================================================
-- ROLES TABLE
-- ============================================================

CREATE TABLE IF NOT EXISTS public.roles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text,
  is_owner_role boolean NOT NULL DEFAULT false,
  is_default_role boolean NOT NULL DEFAULT false,
  is_system boolean NOT NULL DEFAULT false,
  sort_order integer NOT NULL DEFAULT 0,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;

-- All authenticated users can read roles
DROP POLICY IF EXISTS "roles_select_authenticated" ON public.roles;
CREATE POLICY "roles_select_authenticated" ON public.roles
  FOR SELECT TO authenticated USING (true);

-- Only owner role can modify roles
DROP POLICY IF EXISTS "roles_modify_owner" ON public.roles;
CREATE POLICY "roles_modify_owner" ON public.roles
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_profiles
      WHERE user_profiles.id = auth.uid()
      AND user_profiles.role = '{{owner_role}}'
    )
  );

-- ============================================================
-- ROLE PERMISSIONS TABLE
-- ============================================================

CREATE TABLE IF NOT EXISTS public.role_permissions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id uuid NOT NULL REFERENCES public.roles(id) ON DELETE CASCADE,
  permission text NOT NULL CHECK (permission IN (
    'manage_users', 'manage_roles', 'manage_prompts',
    'view_audit_log', 'export_audit_log', 'manage_settings', 'manage_providers'
  )),
  created_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(role_id, permission)
);

ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;

-- All authenticated users can read permissions
DROP POLICY IF EXISTS "role_permissions_select_authenticated" ON public.role_permissions;
CREATE POLICY "role_permissions_select_authenticated" ON public.role_permissions
  FOR SELECT TO authenticated USING (true);

-- Only owner role can modify permissions
DROP POLICY IF EXISTS "role_permissions_modify_owner" ON public.role_permissions;
CREATE POLICY "role_permissions_modify_owner" ON public.role_permissions
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_profiles
      WHERE user_profiles.id = auth.uid()
      AND user_profiles.role = '{{owner_role}}'
    )
  );

-- ============================================================
-- SEED ROLES
-- ============================================================

{{#each roles}}
INSERT INTO public.roles (name, display_name, is_owner_role, is_default_role, is_system, sort_order)
VALUES ('{{this.name}}', '{{this.display_name}}', {{this.is_owner}}, {{this.is_default}}, true, {{@index}})
ON CONFLICT (name) DO NOTHING;
{{/each}}

-- ============================================================
-- SEED PERMISSIONS
-- ============================================================

{{#each permissions_flat}}
INSERT INTO public.role_permissions (role_id, permission)
VALUES (
  (SELECT id FROM public.roles WHERE name = '{{this.role}}'),
  '{{this.permission}}'
)
ON CONFLICT (role_id, permission) DO NOTHING;
{{/each}}

-- ============================================================
-- HELPER FUNCTION: has_permission
-- ============================================================

CREATE OR REPLACE FUNCTION public.has_permission(check_user_id uuid, check_permission text)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_profiles up
    JOIN public.roles r ON r.name = up.role
    JOIN public.role_permissions rp ON rp.role_id = r.id
    WHERE up.id = check_user_id
    AND rp.permission = check_permission
  );
$$;

-- ============================================================
-- HELPER FUNCTION: has_role
-- ============================================================

CREATE OR REPLACE FUNCTION public.has_role(check_user_id uuid, check_role text)
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.user_profiles
    WHERE id = check_user_id AND role = check_role
  );
$$;

-- Updated-at trigger
CREATE OR REPLACE FUNCTION public.update_updated_at()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS roles_updated_at ON public.roles;
CREATE TRIGGER roles_updated_at
  BEFORE UPDATE ON public.roles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();
